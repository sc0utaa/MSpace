@model MSpace2.Data.Entities.Albums
@{
    ViewData["Title"] = "Details";
    var averageRating = ViewBag.AverageRating as double?;
    var ratingCount = ViewBag.RatingCount;
    var userRating = ViewBag.UserRating;
    var showAverage = ratingCount >= 2;
}

<h1>Details</h1>
<div>
    <h4>Albums</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Title)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Title)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ArtistName)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ArtistName)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ReleaseDate)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ReleaseDate)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Description)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Description)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.CoverImageUrl)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.CoverImageUrl)
        </dd>
    </dl>
</div>

<!-- Album Rating Section -->
<div class="album-rating mt-4">
    <h4>Rating</h4>

    @if (showAverage && averageRating.HasValue)
    {
        <div class="average-rating mb-3">
            <strong>Average Rating:</strong>
            <span id="average-rating">@averageRating.Value.ToString("0.0")</span>/10
            <span class="text-muted">(@ratingCount ratings)</span>
        </div>
    }

    @if (User.Identity.IsAuthenticated)
    {
        <div class="user-rating">
            <form id="ratingForm" asp-action="Rate" asp-controller="Albums" method="post">
                <input type="hidden" name="albumId" value="@Model?.Id" />
                <div class="form-group">
                    <label>Rate this album:</label>
                    <div class="rating-selector">
                        @for (int i = 1; i <= 10; i++)
                        {
                            <label class="rating-option @(userRating == i ? "selected" : "")">
                                <input type="radio" name="rating" value="@i" @(userRating == i ? "checked" : "") />
                                <span>@i</span>
                            </label>
                        }
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Submit Rating</button>
            </form>
        </div>
    }
    else
    {
        <p>
            <a asp-area="Identity" asp-page="/Account/Login">Log in</a> to rate this album.
        </p>
    }
</div>

<div class="mt-3">
    <a asp-action="Edit" asp-route-id="@Model?.Id">Edit</a> |
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle AJAX rating submission
            $('#ratingForm').on('submit', function (e) {
                e.preventDefault();

                $.ajax({
                    url: '@Url.Action("Rate", "Albums")',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (result) {
                        if (result.success) {
                            // Update the rating display
                            $('.rating-option').removeClass('selected');
                            $('.rating-option input:checked').closest('.rating-option').addClass('selected');

                            // Update average rating if we have enough ratings
                            if (result.ratingCount >= 2 && result.averageRating != null) {
                                $('#average-rating').text(result.averageRating.toFixed(1));
                                $('.average-rating').show();
                            } else {
                                $('.average-rating').hide();
                            }

                            // Show a success message
                            alert('Rating submitted successfully!');
                        }
                    },
                    error: function () {
                        alert('Error submitting rating. Please try again.');
                    }
                });
            });

            // Highlight selected rating when clicking
            $('.rating-option').click(function () {
                $('.rating-option').removeClass('selected');
                $(this).addClass('selected');
            });
        });
    </script>

    <style>
        .rating-selector {
            display: flex;
            margin-bottom: 15px;
        }

        .rating-option {
            display: inline-block;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            border: 1px solid #ccc;
            margin-right: 5px;
            cursor: pointer;
        }

            .rating-option input {
                display: none;
            }

            .rating-option.selected {
                background-color: #007bff;
                color: white;
                border-color: #007bff;
            }

        .album-rating {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
}